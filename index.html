<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChodeSquad Bingo</title>
    <!-- Screenshot Tool -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Confetti Tool -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.cdnfonts.com/css/runescape-uf');

        :root {
            --bg-flesh-dark: #2a0a0a;
            --bg-flesh-mid: #5a2e2e;
            --tile-flesh: #e6b3b3;
            --tile-border: #8c4b4f;
            --highlight-pink: #ffcccc;
            --active-meat: #b30000;
            --text-dark: #3d0e10;
        }

        body {
            background-color: var(--bg-flesh-dark);
            background-image: radial-gradient(circle at 50% 50%, #3d1010 0%, #1a0505 100%);
            font-family: 'RuneScape UF', sans-serif;
            color: var(--highlight-pink);
            display: flex;
            flex-direction: row; /* Changed to row for side-by-side layout */
            align-items: flex-start;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
            overflow-x: hidden;
            perspective: 1000px;
            gap: 40px;
            padding: 20px;
            flex-wrap: wrap;
        }

        /* --- THE BOARD WRAPPER --- */
        #capture-wrapper {
            padding: 20px;
            background: transparent;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        #capture-area {
            background: var(--bg-flesh-mid);
            padding: 20px;
            border: 4px solid var(--tile-border);
            border-radius: 25px;
            box-shadow: 
                0 0 0 4px #1a0505,
                0 10px 30px rgba(0,0,0,0.5),
                inset 0 0 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 520px;
            position: relative;
            transform: translateZ(0); 
        }

        /* --- RNG SIDEBAR --- */
        .rng-sidebar {
            background: var(--bg-flesh-mid);
            border: 4px solid var(--tile-border);
            border-radius: 25px;
            padding: 20px;
            width: 250px;
            box-shadow: 0 0 0 4px #1a0505, inset 0 0 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: fit-content;
            margin-top: 20px;
        }

        .rng-header {
            text-align: center;
            border-bottom: 2px solid var(--tile-border);
            padding-bottom: 10px;
            margin-bottom: 5px;
            color: var(--highlight-pink);
            text-shadow: 2px 2px 0 #500000;
            font-size: 1.5rem;
        }

        .rng-btn {
            background: var(--tile-flesh);
            border: 3px solid var(--tile-border);
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.1s, background 0.2s;
            position: relative;
            overflow: hidden;
        }

        .rng-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        .rng-btn:active { transform: scale(0.95); }

        .rng-info { text-align: left; }
        .rng-name { color: var(--text-dark); font-weight: bold; font-size: 1.1rem; }
        .rng-rate { color: #5a2e2e; font-size: 0.9rem; }
        .rng-kc { font-size: 0.8rem; color: #888; font-family: monospace; }
        
        .rng-icon { font-size: 2rem; }

        /* Status Indicator Overlay (Top Left) */
        #view-status {
            position: absolute; top: 15px; left: 15px;
            font-size: 16px; background: rgba(0,0,0,0.6);
            padding: 5px 10px; border-radius: 8px; border: 1px solid #555;
            color: #aaa; z-index: 50; pointer-events: none;
        }

        /* Network Sync Status (Top Right) */
        #sync-status {
            position: absolute; top: 15px; right: 15px;
            font-size: 16px; background: rgba(0,0,0,0.6);
            padding: 5px 10px; border-radius: 8px; border: 1px solid #555;
            color: #fff; z-index: 50; pointer-events: none;
            display: flex; align-items: center; gap: 6px;
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .dot.green { background: #0f0; box-shadow: 0 0 5px #0f0; }
        .dot.red { background: #f00; box-shadow: 0 0 5px #f00; }
        .dot.yellow { background: #fa0; box-shadow: 0 0 5px #fa0; }

        .header {
            text-align: center; margin-bottom: 15px; width: 100%;
            border-bottom: 2px solid var(--tile-border); padding-bottom: 15px;
        }

        h1 {
            color: var(--highlight-pink); text-shadow: 2px 2px 0 #500000;
            margin: 0; font-size: 3rem; letter-spacing: 2px;
        }

        /* Liquid Progress Bar */
        .progress-container {
            width: 80%; height: 20px; background: #2a0a0a;
            border: 2px solid var(--tile-border); border-radius: 10px;
            margin: 10px auto 5px auto; overflow: hidden;
            position: relative; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }

        .progress-fill {
            height: 100%; background: linear-gradient(90deg, #8c4b4f, #b30000);
            width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px #ff0000;
        }

        .progress-fill::after {
            content: ''; position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            from { transform: translateX(-100%); } to { transform: translateX(100%); }
        }

        .progress-text {
            color: #d48a8a; font-size: 1rem; margin-top: 5px; text-shadow: 1px 1px 0 #000;
        }

        .grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 10px; background: rgba(0,0,0,0.2);
            padding: 10px; border-radius: 15px;
            border: 2px solid var(--tile-border); width: 100%;
            box-sizing: border-box;
        }

        /* --- TILE DESIGN --- */
        .tile {
            background-color: var(--tile-flesh); 
            color: var(--text-dark);
            aspect-ratio: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; padding: 5px;
            border: 3px solid var(--tile-border); border-radius: 15px;
            cursor: pointer; box-shadow: inset 2px 2px 5px rgba(255,255,255,0.4), inset -2px -2px 5px rgba(0,0,0,0.2);
            position: relative; transition: all 0.2s;
            font-weight: bold; animation: breathe 3s infinite ease-in-out;
            overflow: hidden;
            
            /* Image handling */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-blend-mode: luminosity; /* Makes it look grayscaleish/faded */
        }

        .tile.readonly { cursor: url('https://oldschool.runescape.wiki/images/Dragon_scimitar.png?123'), pointer; }

        @keyframes breathe {
            0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); }
        }

        .tile:hover {
            transform: scale(1.1) !important; 
            z-index: 10; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            background-blend-mode: normal; /* Color on hover */
        }

        .tile-name {
            font-size: 14px; line-height: 1.1; z-index: 2; pointer-events: none;
            /* Text readability background */
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 4px;
            border-radius: 4px;
            width: 90%;
            text-shadow: 1px 1px 0 #000;
        }

        .tile.done {
            /* Full Color when done */
            background-color: var(--active-meat); 
            color: #ffcccc;
            border-color: #ff9999; 
            box-shadow: inset 0 0 15px #330000, 0 0 15px var(--active-meat);
            animation: none;
            background-blend-mode: normal; 
        }

        /* Loot Beam Effect */
        .tile.done::before {
            content: ''; position: absolute;
            width: 200%; height: 200%;
            background: conic-gradient(from 0deg, transparent 0%, rgba(255,255,255,0.3) 10%, transparent 20%);
            animation: rotateBeam 4s linear infinite;
            top: -50%; left: -50%; z-index: 1; pointer-events: none;
            transition: animation-duration 0.3s;
        }
        .tile.done:hover::before { animation-duration: 1s; }

        @keyframes rotateBeam {
            from { transform: rotate(0deg); } to { transform: rotate(360deg); }
        }

        .check-mark {
            display: none; position: absolute;
            top: 4px; right: 6px; color: #fff;
            font-size: 16px; filter: drop-shadow(1px 1px 0 #000);
            z-index: 5;
        }
        .tile.done .check-mark { display: block; }

        .xp-drop {
            position: absolute; color: #ffff00; font-weight: normal;
            font-family: 'RuneScape UF', sans-serif; font-size: 2rem;
            pointer-events: none; animation: floatUp 1.5s cubic-bezier(0, 0.5, 0.5, 1) forwards;
            text-shadow: 2px 2px 0 #000; z-index: 100;
            display: flex; align-items: center; justify-content: center;
            background: url('https://oldschool.runescape.wiki/images/Bingo_lamp.png?123') no-repeat left center;
            background-size: 24px; padding-left: 28px;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(0.5); }
            10% { transform: translateY(-10px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-100px) scale(1); }
        }

        @keyframes squish {
            0% { transform: scale(1); } 40% { transform: scale(0.9, 1.1); }
            60% { transform: scale(1.1, 0.9); } 100% { transform: scale(1); }
        }
        .clicked { animation: squish 0.15s ease-in-out; }

        .floater {
            position: absolute; color: #fff; font-weight: bold;
            font-size: 1.5rem; pointer-events: none;
            animation: floatUp 1s forwards; text-shadow: 2px 2px 0 #000; z-index: 100;
        }

        /* Buttons */
        .controls {
            margin-top: 25px; display: flex; gap: 15px;
            justify-content: center; transform: translateZ(0);
            flex-wrap: wrap; max-width: 600px;
            width: 100%;
        }

        button {
            background: var(--tile-border); color: var(--highlight-pink);
            border: none; border-radius: 20px; padding: 12px 24px;
            font-family: 'RuneScape UF', sans-serif; font-size: 1.1rem;
            cursor: pointer; box-shadow: 0 4px 0 #500000; transition: transform 0.1s;
            display: flex; align-items: center; gap: 5px;
        }
        button:hover { filter: brightness(1.2); }
        button:active { transform: translateY(4px); box-shadow: none; }
        
        button.primary { background: #b30000; color: white; }
        button.secondary { background: #5a2e2e; color: #aaa; font-size: 1rem; }
        button.hype { background: linear-gradient(45deg, #ff00ff, #00ffff); color: white; text-shadow: 1px 1px 0 #000; }

        /* Setup Overlays */
        #setup-overlay, #db-error-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            color: #fff; font-family: sans-serif;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center;
        }
        #setup-overlay h2, #db-error-overlay h2 { color: var(--highlight-pink); margin-bottom: 20px; }
        #setup-overlay p, #db-error-overlay p { max-width: 600px; line-height: 1.6; color: #ddd; margin-bottom: 20px; }
        #setup-overlay pre { background: #222; padding: 15px; border-radius: 8px; text-align: left; }
        
        .error-steps {
            background: #222; padding: 20px; border-radius: 10px;
            border: 1px solid #555; text-align: left;
        }
        .error-steps a { text-decoration: underline; font-weight: bold; }

        /* Toast */
        #toast {
            position: fixed; bottom: 30px; background: #222;
            border: 2px solid var(--highlight-pink); color: var(--highlight-pink);
            padding: 15px 30px; display: none; z-index: 100;
            border-radius: 10px; box-shadow: 0 5px 20px #000; font-size: 1.2rem;
        }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            justify-content: center; align-items: center;
            flex-direction: column; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--bg-flesh-mid); padding: 20px;
            border: 3px solid var(--tile-border); border-radius: 20px;
            text-align: center; box-shadow: 0 0 30px #000;
        }
        .modal-content img {
            max-width: 90vw; max-height: 70vh;
            border: 2px solid #000; display: block;
            margin: 15px auto; border-radius: 10px;
        }
        
        /* Mobile Layout Adjustment */
        @media (max-width: 850px) {
            body { flex-direction: column; align-items: center; }
            .rng-sidebar { width: 90%; max-width: 500px; order: 2; }
            #capture-wrapper { order: 1; padding: 10px; }
            #capture-area { width: 100%; max-width: 520px; }
        }
    </style>
</head>
<body>

    <!-- GUIDE IF NO CONFIG -->
    <div id="setup-overlay">
        <h2>One-Time Setup Required</h2>
        <p>You need to tell the site where to send the data (Firebase).</p>
        <button class="primary" onclick="location.reload()">I Added The Config!</button>
    </div>

    <!-- GUIDE IF DB ERROR -->
    <div id="db-error-overlay">
        <h2>üõë Connection Issue</h2>
        <p><b>Error:</b> The app cannot connect to the cloud database.</p>
        <div class="error-steps">
            <p>1. <a href="#" id="enable-api-link" target="_blank" style="color:#aaf;">Click Here to Enable Firestore API</a></p>
            <p>2. Wait 2 minutes.</p>
            <p>3. Refresh.</p>
        </div>
        <br>
        <button class="secondary" onclick="enableOfflineMode()">Continue Offline (No Sync)</button>
    </div>

    <div id="capture-wrapper">
        <div id="capture-area">
            <!-- Indicators -->
            <div id="view-status">üîí View Only</div>
            <div id="sync-status"><span class="dot yellow" id="sync-dot"></span> <span id="sync-text">Connecting...</span></div>

            <div class="header">
                <h1>CHODESQUAD</h1>
                
                <div class="progress-container">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-label">0 / 16 COMPLETE</div>
            </div>

            <div class="grid" id="grid">
                <!-- Tiles generated by JS -->
            </div>
        </div>
        
        <div class="controls" data-html2canvas-ignore="true">
            <button class="primary" onclick="toggleAdmin()" id="login-btn">üîë Admin Login</button>
            <button class="secondary" onclick="toggleMute()" id="mute-btn">üîä ON</button>
            <button class="hype" onclick="localHype()">üéâ HYPE</button>
            <button class="secondary" onclick="copyImage()" id="copy-btn">üì∏ Copy Image</button>
            <button class="secondary" onclick="resetBoard()" id="reset-btn" style="display:none">üóëÔ∏è Reset</button>
        </div>
    </div>

    <!-- RNG Sidebar -->
    <div class="rng-sidebar">
        <div class="rng-header">XP WASTING</div>
        <div id="rng-container">
            <!-- Items injected by JS -->
        </div>
    </div>

    <div id="toast">Image copied! Paste in Discord (Ctrl+V)</div>

    <div id="modal-overlay" class="modal-overlay" data-html2canvas-ignore="true">
        <div class="modal-content">
            <h2 style="margin:0; color:var(--highlight-pink); text-shadow:1px 1px 0 #000;">Board Snapshot</h2>
            <img id="modal-img">
            <button onclick="closeModal()">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================================
        //  FIREBASE CONFIGURATION
        // ==========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyASY3qQeFHqb50lCa2Rg57ILm1p2BSfHSQ",
            authDomain: "chodesquad-tracker.firebaseapp.com",
            projectId: "chodesquad-tracker",
            storageBucket: "chodesquad-tracker.firebasestorage.app",
            messagingSenderId: "76093275740",
            appId: "1:76093275740:web:b8b4fabf69959b67b8f099"
        };
        // ==========================================================

        const ADMIN_PASSWORD = "chode"; 
        const TILT_STRENGTH = 4;
        
        const tasks = [
            "2x Crystal Armour Seeds", "Boss Pet", "Clue Unique > 1M GP", "2x GWD Uniques",
            "Blood Shard", "Basilisk Jaw", "Nightmare Unique", "2 Raid Purples",
            "2.5M Sailing XP", "2x Zulrah Uniques", "Fox Whistle OR Golden Pheasant", "Zalcano Unique",
            "Zealot's Robes", "Voidwaker Gem", "5x TzHaar Uniques", "Dragon Warhammer"
        ];

        // UPDATED to .png as requested
        const taskFilenames = [
            "crystal-armour-seeds.png", "boss-pet.png", "clue-unique.png", "gwd-uniques.png",
            "blood-shard.png", "basilisk-jaw.png", "nightmare-unique.png", "raid-purples.png",
            "sailing-xp.png", "zulrah-uniques.png", "fox-whistle.png", "zalcano-unique.png",
            "zealots-robes.png", "voidwaker-gem.png", "tzhaar-uniques.png", "dragon-warhammer.png"
        ];

        // RNG GAME DATA
        const rngGames = [
            { name: "Goblin", rate: 10, icon: "üëπ", drop: "Mind Rune" },
            { name: "Dragon", rate: 128, icon: "üêâ", drop: "Dragon Legs" },
            { name: "Boss", rate: 512, icon: "üíÄ", drop: "Unique Item" },
            { name: "Pet", rate: 5000, icon: "üêæ", drop: "Lil' Creator" },
            { name: "3rd Age", rate: 32768, icon: "üíé", drop: "3rd Age Pick" }
        ];

        let state = tasks.map(() => ({ done: false }));
        // RNG Stats are purely local
        let rngStats = JSON.parse(localStorage.getItem('chode_rng_stats')) || rngGames.map(() => ({ kc: 0 }));

        let isAdmin = false; 
        let isMuted = false;
        let isOffline = false;
        let db, boardRef;
        let connectionTimeout;

        const sounds = {
            click: new Audio('https://oldschool.runescape.wiki/images/Interface_click.ogg'),
            complete: new Audio('https://oldschool.runescape.wiki/images/Genie_appear.ogg'),
            win: new Audio('https://oldschool.runescape.wiki/images/Level_up_fanfare.ogg')
        };
        Object.values(sounds).forEach(s => s.volume = 0.5);

        async function init() {
            if (!firebaseConfig.apiKey) {
                document.getElementById('setup-overlay').style.display = 'flex';
                return;
            }

            // Init RNG Board
            renderRngBoard();

            const link = document.getElementById('enable-api-link');
            if (link) {
                link.href = `https://console.developers.google.com/apis/api/firestore.googleapis.com/overview?project=${firebaseConfig.projectId}`;
            }

            updateSyncStatus('yellow', 'Connecting...');

            // Watchdog
            connectionTimeout = setTimeout(() => {
                handleDbError({ code: 'timeout' });
            }, 6000);

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                boardRef = doc(db, "bingo", "chodesquad_v1");

                onSnapshot(boardRef, {
                    next: (docSnap) => {
                        clearTimeout(connectionTimeout); 
                        updateSyncStatus('green', 'Synced');
                        if (docSnap.exists()) {
                            state = docSnap.data().tiles;
                            render();
                        } else {
                            setDoc(boardRef, { tiles: state }).catch(e => handleDbError(e));
                        }
                    },
                    error: (error) => {
                        clearTimeout(connectionTimeout);
                        handleDbError(error);
                    }
                });

            } catch (err) {
                clearTimeout(connectionTimeout);
                handleDbError(err);
            }

            // Load backup just in case
            const local = localStorage.getItem('chode_offline_backup');
            if (local) state = JSON.parse(local);
            render();
        }

        function handleDbError(error) {
            console.error("Database Error:", error);
            updateSyncStatus('red', 'Connection Failed');
            document.getElementById('db-error-overlay').style.display = 'flex';
        }

        function updateSyncStatus(color, text) {
            document.getElementById('sync-dot').className = `dot ${color}`;
            document.getElementById('sync-text').innerText = text;
        }

        function renderRngBoard() {
            const container = document.getElementById('rng-container');
            container.innerHTML = '';
            
            rngGames.forEach((game, index) => {
                const btn = document.createElement('div');
                btn.className = 'rng-btn';
                const currentKc = rngStats[index]?.kc || 0;
                
                btn.innerHTML = `
                    <div class="rng-info">
                        <div class="rng-name">${game.name}</div>
                        <div class="rng-rate">1/${game.rate}</div>
                        <div class="rng-kc">KC: ${currentKc}</div>
                    </div>
                    <div class="rng-icon">${game.icon}</div>
                `;
                
                btn.onclick = (e) => rollRng(index, e);
                container.appendChild(btn);
            });
        }

        function rollRng(index, e) {
            const game = rngGames[index];
            
            // Increment KC
            rngStats[index] = rngStats[index] || { kc: 0 };
            rngStats[index].kc++;
            localStorage.setItem('chode_rng_stats', JSON.stringify(rngStats));
            renderRngBoard(); // update UI
            
            // Roll
            const roll = Math.floor(Math.random() * game.rate) + 1;
            
            if (roll === 1) {
                // DROP!
                playSound('win');
                triggerConfetti();
                spawnXpDrop(e.clientX, e.clientY, `DROP: ${game.drop}!`);
            } else {
                // Dry
                playSound('click');
                spawnFloater(e.clientX, e.clientY, "Nothing interesting happens.");
            }
        }

        function render() {
            const grid = document.getElementById('grid');
            const progressLabel = document.getElementById('progress-label');
            const progressFill = document.getElementById('progress-fill');
            const viewStatus = document.getElementById('view-status');
            const loginBtn = document.getElementById('login-btn');
            const resetBtn = document.getElementById('reset-btn');

            grid.innerHTML = '';
            let completedCount = 0;

            viewStatus.innerText = isAdmin ? "üîì Admin Mode" : "üîí View Only";
            viewStatus.style.color = isAdmin ? "#0f0" : "#aaa";
            
            loginBtn.innerText = isAdmin ? "üîì Logged In" : "üîë Admin Login";
            resetBtn.style.display = isAdmin ? "inline-block" : "none";

            tasks.forEach((taskName, i) => {
                const tileData = state[i] || { done: false };
                
                const tile = document.createElement('div');
                tile.className = 'tile';
                
                // Add the image background (assumes images/ folder is relative)
                tile.style.backgroundImage = `url('images/${taskFilenames[i]}')`;

                if (!isAdmin) tile.classList.add('readonly');
                tile.style.animationDelay = `${Math.random() * 2}s`;
                
                if (tileData.done) {
                    tile.classList.add('done');
                    completedCount++;
                }

                tile.innerHTML = `
                    <div class="check-mark">‚úì</div>
                    <div class="tile-name">${taskName}</div>
                `;

                tile.onclick = (e) => {
                    if (!isAdmin) {
                        animateClick(tile);
                        playSound('click');
                        confetti({
                            particleCount: 15, spread: 40,
                            origin: { x: e.clientX / window.innerWidth, y: e.clientY / window.innerHeight },
                            colors: ['#8c4b4f', '#b30000', '#5a2e2e'],
                            scalar: 0.8, shapes: ['circle']
                        });
                        const words = ["SQUISH", "POKE", "PLOP", "MOIST", "THWACK", "EW"];
                        spawnFloater(e.clientX, e.clientY, words[Math.floor(Math.random() * words.length)]);
                        return;
                    }

                    // Admin Actions
                    tileData.done = !tileData.done;
                    animateClick(tile);
                    
                    if (tileData.done) {
                        playSound('complete');
                        spawnXpDrop(e.clientX, e.clientY, "+1 Bingo XP");
                        triggerConfetti(); 
                    } else {
                        playSound('click');
                        spawnFloater(e.clientX, e.clientY, "UNDO");
                    }

                    saveData(); // <--- THIS SAVES FOR EVERYONE
                    render(); 
                    if (tileData.done && completedCount === 15) checkWin(); 
                };

                grid.appendChild(tile);
            });

            progressLabel.innerText = `${completedCount} / 16 COMPLETE`;
            const pct = (completedCount / 16) * 100;
            progressFill.style.width = `${pct}%`;

            if (completedCount === 16) {
                progressLabel.style.color = '#fff';
                progressLabel.innerHTML = "üí¶ BLACKOUT COMPLETE! üí¶";
            } else {
                progressLabel.style.color = '#d48a8a';
            }
        }

        function saveData() {
            if (isOffline) {
                localStorage.setItem('chode_offline_backup', JSON.stringify(state));
                updateSyncStatus('yellow', 'Saved Locally (Offline)');
            } else if (boardRef) {
                updateSyncStatus('yellow', 'Saving...');
                updateDoc(boardRef, { tiles: state })
                    .then(() => updateSyncStatus('green', 'Saved Publicly'))
                    .catch(e => {
                        console.error("Save failed", e);
                        updateSyncStatus('red', 'Save Failed');
                        if (e.code === 'permission-denied') {
                            alert("SAVE FAILED: Permission Denied.\n\nYou need to update your Firestore Database Rules.\n\n1. Go to Firebase Console -> Build -> Firestore Database -> Rules\n2. Change 'allow read, write: if false;' to 'allow read, write: if true;'\n3. Click Publish.");
                        } else {
                            alert("Save Failed: " + e.message);
                        }
                    });
            }
        }

        window.enableOfflineMode = () => {
            isOffline = true;
            document.getElementById('db-error-overlay').style.display = 'none';
            const backup = localStorage.getItem('chode_offline_backup');
            if(backup) state = JSON.parse(backup);
            render();
            updateSyncStatus('red', 'Offline Mode');
            showToast("Offline Mode Active");
        };

        window.toggleAdmin = () => {
            playSound('click');
            if (isAdmin) {
                isAdmin = false;
                render();
            } else {
                const pass = prompt("Enter Admin Password:");
                if (pass === ADMIN_PASSWORD) {
                    isAdmin = true;
                    render();
                    showToast("Admin Mode Active");
                } else if (pass !== null) {
                    alert("Wrong password!");
                }
            }
        };
        
        window.toggleMute = () => {
            isMuted = !isMuted;
            document.getElementById('mute-btn').innerText = isMuted ? "üîá OFF" : "üîä ON";
        };

        window.localHype = () => { playSound('win'); checkWin(); };

        window.resetBoard = () => {
            if (!isAdmin) return;
            if(confirm("Clear the board for EVERYONE?")) {
                state = tasks.map(() => ({ done: false }));
                saveData();
                render();
            }
        };

        function animateClick(element) {
            element.classList.remove('clicked');
            void element.offsetWidth; 
            element.classList.add('clicked');
        }
        
        function playSound(name) {
            if (isMuted || !sounds[name]) return;
            const s = sounds[name].cloneNode();
            s.volume = 0.4;
            s.play().catch(e => {});
        }

        function spawnFloater(x, y, text) {
            const el = document.createElement('div');
            el.className = 'floater';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }
        
        function spawnXpDrop(x, y, text) {
            const el = document.createElement('div');
            el.className = 'xp-drop';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }

        function triggerConfetti() {
            confetti({ particleCount: 40, spread: 70, origin: { y: 0.7 }, colors: ['#ffcccc', '#ff9999', '#ffffff', '#b30000'] });
        }

        function checkWin() {
            var duration = 3000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
            var randomInRange = (min, max) => Math.random() * (max - min) + min;
            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                var particleCount = 50 * (timeLeft / duration);
                var colors = ['#ffcccc', '#ff9999', '#ffffff', '#b30000'];
                confetti(Object.assign({}, defaults, { particleCount, colors: colors, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, colors: colors, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        document.addEventListener('mousemove', (e) => {
            if (window.innerWidth < 768) return;
            const wrapper = document.getElementById('capture-wrapper');
            const x = e.clientX / window.innerWidth;
            const y = e.clientY / window.innerHeight;
            wrapper.style.transform = `perspective(1000px) rotateX(${(0.5 - y) * TILT_STRENGTH}deg) rotateY(${(x - 0.5) * TILT_STRENGTH}deg)`;
        });

        window.copyImage = async () => {
            document.getElementById('capture-wrapper').style.transform = 'none';
            const copyBtn = document.getElementById('copy-btn');
            const originalText = copyBtn.innerText;
            copyBtn.innerText = "Generating...";
            try {
                await new Promise(r => setTimeout(r, 50));
                const canvas = await html2canvas(document.getElementById('capture-area'), {
                    backgroundColor: null, scale: 2, 
                    ignoreElements: (el) => el.hasAttribute('data-html2canvas-ignore') || el.id === 'status-overlay' || el.id === 'sync-status' || el.id === 'view-status'
                });
                canvas.toBlob(async blob => {
                    try {
                        const item = new ClipboardItem({ "image/png": blob });
                        await navigator.clipboard.write([item]);
                        window.showToast("Image Copied!");
                    } catch (err) {
                        window.showModal(canvas.toDataURL());
                    }
                    copyBtn.innerText = originalText;
                });
            } catch (err) {
                console.error(err);
                alert("Error generating image.");
                copyBtn.innerText = originalText;
            }
        };

        window.showModal = (dataUrl) => {
            document.getElementById('modal-img').src = dataUrl;
            document.getElementById('modal-overlay').style.display = 'flex';
        };
        window.closeModal = () => document.getElementById('modal-overlay').style.display = 'none';
        
        window.showToast = (text) => {
            const t = document.getElementById('toast');
            if(text) t.innerText = text;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        };

        init();

    </script>
</body>
</html>
