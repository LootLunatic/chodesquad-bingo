<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChodeSquad Bingo</title>
    <!-- Screenshot Tool -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Confetti Tool -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.cdnfonts.com/css/runescape-uf');

        :root {
            --bg-flesh-dark: #2a0a0a;
            --bg-flesh-mid: #5a2e2e;
            --tile-flesh: #e6b3b3;
            --tile-border: #8c4b4f;
            --highlight-pink: #ffcccc;
            --active-meat: #b30000;
            --text-dark: #3d0e10;
        }

        body {
            background-color: var(--bg-flesh-dark);
            background-image: radial-gradient(circle at 50% 50%, #3d1010 0%, #1a0505 100%);
            font-family: 'RuneScape UF', sans-serif;
            color: var(--highlight-pink);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
            overflow-x: hidden;
            perspective: 1000px;
        }

        /* --- THE BOARD WRAPPER --- */
        #capture-wrapper {
            padding: 40px;
            background: transparent;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        #capture-area {
            background: var(--bg-flesh-mid);
            padding: 20px;
            border: 4px solid var(--tile-border);
            border-radius: 25px;
            box-shadow: 
                0 0 0 4px #1a0505,
                0 10px 30px rgba(0,0,0,0.5),
                inset 0 0 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 520px;
            position: relative;
            transform: translateZ(0); 
        }

        /* Status Indicator Overlay */
        #status-overlay {
            position: absolute;
            top: 15px; left: 15px;
            font-size: 16px;
            background: rgba(0,0,0,0.6);
            padding: 5px 10px;
            border-radius: 8px;
            border: 1px solid #555;
            color: #aaa;
            z-index: 50;
            pointer-events: none;
            transition: color 0.3s;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            width: 100%;
            border-bottom: 2px solid var(--tile-border);
            padding-bottom: 15px;
        }

        h1 {
            color: var(--highlight-pink);
            text-shadow: 2px 2px 0 #500000;
            margin: 0;
            font-size: 3rem;
            letter-spacing: 2px;
        }

        /* Liquid Progress Bar */
        .progress-container {
            width: 80%;
            height: 20px;
            background: #2a0a0a;
            border: 2px solid var(--tile-border);
            border-radius: 10px;
            margin: 10px auto 5px auto;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8c4b4f, #b30000);
            width: 0%; 
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px #ff0000;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        .progress-text {
            color: #d48a8a;
            font-size: 1rem;
            margin-top: 5px;
            text-shadow: 1px 1px 0 #000;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 15px;
            border: 2px solid var(--tile-border);
            width: 100%;
            box-sizing: border-box;
        }

        /* --- TILE DESIGN --- */
        .tile {
            background: var(--tile-flesh);
            color: var(--text-dark);
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            border: 3px solid var(--tile-border);
            border-radius: 15px;
            cursor: pointer;
            box-shadow: inset 2px 2px 5px rgba(255,255,255,0.4), inset -2px -2px 5px rgba(0,0,0,0.2);
            position: relative;
            transition: all 0.2s;
            font-weight: bold;
            animation: breathe 3s infinite ease-in-out;
            overflow: hidden; /* For loot beam containment */
        }

        /* View Mode is now interactive "Tactile Mode" */
        .tile.readonly {
            cursor: url('https://oldschool.runescape.wiki/images/Dragon_scimitar.png?123'), pointer;
        }
        /* No transform disable on readonly anymore, we want them to feel it */

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .tile:hover {
            transform: scale(1.1) !important;
            background: #ffe6e6;
            z-index: 10;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .tile-name {
            font-size: 14px;
            line-height: 1.1;
            z-index: 2;
            pointer-events: none;
        }

        /* Completed State */
        .tile.done {
            background: var(--active-meat);
            color: #ffcccc;
            border-color: #ff9999;
            box-shadow: inset 0 0 15px #330000, 0 0 15px var(--active-meat);
            animation: none; 
        }

        /* Loot Beam Effect */
        .tile.done::before {
            content: '';
            position: absolute;
            width: 200%; height: 200%;
            background: conic-gradient(from 0deg, transparent 0%, rgba(255,255,255,0.3) 10%, transparent 20%);
            animation: rotateBeam 4s linear infinite;
            top: -50%; left: -50%;
            z-index: 1;
            pointer-events: none;
            transition: animation-duration 0.3s;
        }

        /* Spin faster on hover (Interactive) */
        .tile.done:hover::before {
            animation-duration: 1s; /* Turbo speed */
        }

        @keyframes rotateBeam {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .check-mark {
            display: none;
            position: absolute;
            top: 4px; right: 6px;
            color: #fff;
            font-size: 16px;
            filter: drop-shadow(1px 1px 0 #000);
            z-index: 5;
        }
        .tile.done .check-mark { display: block; }

        /* XP DROP (New Floater) */
        .xp-drop {
            position: absolute;
            color: #ffff00; /* OSRS XP Yellow */
            font-weight: normal;
            font-family: 'RuneScape UF', sans-serif;
            font-size: 2rem;
            pointer-events: none;
            animation: floatUp 1.5s cubic-bezier(0, 0.5, 0.5, 1) forwards;
            text-shadow: 2px 2px 0 #000;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            background: url('https://oldschool.runescape.wiki/images/Bingo_lamp.png?123') no-repeat left center;
            background-size: 24px;
            padding-left: 28px;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(0.5); }
            10% { transform: translateY(-10px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-100px) scale(1); }
        }

        @keyframes squish {
            0% { transform: scale(1); }
            40% { transform: scale(0.9, 1.1); }
            60% { transform: scale(1.1, 0.9); }
            100% { transform: scale(1); }
        }
        .clicked { animation: squish 0.15s ease-in-out; } /* Faster squish */

        /* Buttons */
        .controls {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            justify-content: center;
            transform: translateZ(0);
            flex-wrap: wrap;
            max-width: 600px;
        }

        button {
            background: var(--tile-border);
            color: var(--highlight-pink);
            border: none;
            border-radius: 20px;
            padding: 12px 24px;
            font-family: 'RuneScape UF', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 0 4px 0 #500000;
            transition: transform 0.1s;
            display: flex; align-items: center; gap: 5px;
        }
        button:hover { filter: brightness(1.2); }
        button:active { transform: translateY(4px); box-shadow: none; }
        
        button.primary { background: #b30000; color: white; }
        button.secondary { background: #5a2e2e; color: #aaa; font-size: 1rem; }
        button.hype { background: linear-gradient(45deg, #ff00ff, #00ffff); color: white; text-shadow: 1px 1px 0 #000; }

        /* Setup Overlays */
        #setup-overlay, #db-error-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            color: #fff; font-family: sans-serif;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center;
        }
        #setup-overlay h2, #db-error-overlay h2 { color: var(--highlight-pink); margin-bottom: 20px; }
        #setup-overlay p, #db-error-overlay p { max-width: 600px; line-height: 1.6; color: #ddd; margin-bottom: 20px; }
        #setup-overlay pre { background: #222; padding: 15px; border-radius: 8px; text-align: left; }
        .error-code { color: #f55; font-family: monospace; background: #300; padding: 4px; border-radius: 4px; }
        
        .error-steps {
            background: #222; padding: 20px; border-radius: 10px;
            border: 1px solid #555; text-align: left;
        }
        .error-steps a { text-decoration: underline; font-weight: bold; }

        /* Toast Notification */
        #toast {
            position: fixed; bottom: 30px;
            background: #222; border: 2px solid var(--highlight-pink);
            color: var(--highlight-pink); padding: 15px 30px;
            display: none; z-index: 100;
            border-radius: 10px;
            box-shadow: 0 5px 20px #000;
            font-size: 1.2rem;
        }

        /* Modal for Fallback */
        .modal-overlay {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            justify-content: center; align-items: center;
            flex-direction: column; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: var(--bg-flesh-mid); padding: 20px;
            border: 3px solid var(--tile-border);
            border-radius: 20px;
            text-align: center; box-shadow: 0 0 30px #000;
        }
        .modal-content img {
            max-width: 90vw; max-height: 70vh;
            border: 2px solid #000; display: block;
            margin: 15px auto;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <!-- GUIDE IF NO CONFIG -->
    <div id="setup-overlay">
        <h2>One-Time Setup Required</h2>
        <p>To have a "Magic Board" that updates for everyone, the data needs a home in the cloud.<br>
        Websites cannot remember data on their own.</p>
        <p><b>1.</b> Go to console.firebase.google.com (Free)<br>
        <b>2.</b> Create Project -> Add Web App<br>
        <b>3.</b> Copy the `firebaseConfig` object.<br>
        <b>4.</b> Edit this HTML file and paste it where it says "PASTE CONFIG HERE".</p>
        <button class="primary" onclick="location.reload()">I Added The Config!</button>
    </div>

    <!-- GUIDE IF DATABASE MISSING OR PERMISSION DENIED -->
    <div id="db-error-overlay">
        <h2>üõë Connection Issue</h2>
        <p><b>Error:</b> The app cannot connect to the cloud database.</p>
        <div class="error-steps">
            <p><b>Cause:</b> The Firestore API is likely disabled or the Database isn't created.</p>
            <p>1. <a href="#" id="enable-api-link" target="_blank" style="color:#aaf; font-size:1.1rem;">Click Here to Enable Firestore API</a></p>
            <p>2. Wait 2 minutes for Google to process it.</p>
            <p>3. Refresh this page.</p>
        </div>
        <br>
        <div style="border-top:1px solid #444; margin-top:10px; padding-top:10px; width:100%;">
            <p style="font-size:0.9rem; color:#aaa;">Can't fix it right now?</p>
            <button class="secondary" onclick="enableOfflineMode()">Continue Offline (No Sync)</button>
        </div>
    </div>

    <div id="capture-wrapper">
        <div id="capture-area">
            <!-- Status Text -->
            <div id="status-overlay">üîí View Only (Poke Mode)</div>

            <div class="header">
                <h1>CHODESQUAD</h1>
                
                <div class="progress-container">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-label">0 / 16 COMPLETE</div>
            </div>

            <div class="grid" id="grid">
                <!-- Tiles generated by JS -->
            </div>
        </div>
    </div>

    <div class="controls" data-html2canvas-ignore="true">
        <button class="primary" onclick="toggleAdmin()" id="login-btn">üîë Admin Login</button>
        <button class="secondary" onclick="toggleMute()" id="mute-btn">üîä ON</button>
        <button class="hype" onclick="localHype()">üéâ HYPE</button>
        <button class="secondary" onclick="copyImage()" id="copy-btn">üì∏ Copy Image</button>
        <button class="secondary" onclick="resetBoard()" id="reset-btn" style="display:none">üóëÔ∏è Reset</button>
    </div>

    <div id="toast">Image copied! Paste in Discord (Ctrl+V)</div>

    <!-- Fallback Modal -->
    <div id="modal-overlay" class="modal-overlay" data-html2canvas-ignore="true">
        <div class="modal-content">
            <h2 style="margin:0; color:var(--highlight-pink); text-shadow:1px 1px 0 #000;">Board Snapshot</h2>
            <p style="color:#d48a8a;">Right-click the image below -> <b>Copy Image</b></p>
            <img id="modal-img" alt="Bingo Board Preview">
            <button onclick="closeModal()">Close</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase (No build tools needed)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ==========================================================
        //  FIREBASE CONFIGURATION
        // ==========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyASY3qQeFHqb50lCa2Rg57ILm1p2BSfHSQ",
            authDomain: "chodesquad-tracker.firebaseapp.com",
            projectId: "chodesquad-tracker",
            storageBucket: "chodesquad-tracker.firebasestorage.app",
            messagingSenderId: "76093275740",
            appId: "1:76093275740:web:b8b4fabf69959b67b8f099"
        };
        // ==========================================================

        const ADMIN_PASSWORD = "chode"; 
        const TILT_STRENGTH = 4;
        
        const tasks = [
            "2x Crystal Armour Seeds", "Boss Pet", "Clue Unique > 1M GP", "2x GWD Uniques",
            "Blood Shard", "Basilisk Jaw", "Nightmare Unique", "2 Raid Purples",
            "2.5M Sailing XP", "2x Zulrah Uniques", "Fox Whistle OR Golden Pheasant", "Zalcano Unique",
            "Zealot's Robes", "Voidwaker Gem", "5x TzHaar Uniques", "Dragon Warhammer"
        ];

        let state = tasks.map(() => ({ done: false }));
        let isAdmin = false;
        let isMuted = false;
        let isOffline = false; // New offline flag
        let db, boardRef;
        let connectionTimeout;

        // --- AUDIO SYSTEM ---
        const sounds = {
            click: new Audio('https://oldschool.runescape.wiki/images/Interface_click.ogg'),
            complete: new Audio('https://oldschool.runescape.wiki/images/Genie_appear.ogg'),
            win: new Audio('https://oldschool.runescape.wiki/images/Level_up_fanfare.ogg')
        };
        Object.values(sounds).forEach(s => s.volume = 0.5);

        // --- INIT ---
        async function init() {
            if (!firebaseConfig.apiKey) {
                document.getElementById('setup-overlay').style.display = 'flex';
                return;
            }

            // Set up the API link in the error overlay dynamically
            const link = document.getElementById('enable-api-link');
            if (link) {
                link.href = `https://console.developers.google.com/apis/api/firestore.googleapis.com/overview?project=${firebaseConfig.projectId}`;
            }

            // Watchdog: If DB doesn't respond in 6 seconds, assume error
            connectionTimeout = setTimeout(() => {
                console.warn("Connection watchdog triggered.");
                handleDbError({ code: 'timeout', message: 'Connection timed out.' });
            }, 6000);

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                boardRef = doc(db, "bingo", "chodesquad_v1");

                onSnapshot(boardRef, {
                    next: (docSnap) => {
                        clearTimeout(connectionTimeout); 
                        if (docSnap.exists()) {
                            state = docSnap.data().tiles;
                            render();
                        } else {
                            setDoc(boardRef, { tiles: state }).catch(e => handleDbError(e));
                        }
                    },
                    error: (error) => {
                        clearTimeout(connectionTimeout);
                        handleDbError(error);
                    }
                });

            } catch (err) {
                clearTimeout(connectionTimeout);
                handleDbError(err);
            }

            // Attempt to load from local storage if previously used offline
            const local = localStorage.getItem('chode_offline_backup');
            if (local) state = JSON.parse(local);
            render();
        }

        function handleDbError(error) {
            console.error("Database Error Details:", error);
            // Show error screen with offline option
            document.getElementById('db-error-overlay').style.display = 'flex';
        }

        // --- RENDER ---
        function render() {
            const grid = document.getElementById('grid');
            const progressLabel = document.getElementById('progress-label');
            const progressFill = document.getElementById('progress-fill');
            const statusOverlay = document.getElementById('status-overlay');
            const loginBtn = document.getElementById('login-btn');
            const resetBtn = document.getElementById('reset-btn');

            grid.innerHTML = '';
            let completedCount = 0;

            let statusText = isOffline ? "‚ö†Ô∏è Offline Mode (Local Only)" : "üîí View Only (Poke Mode)";
            if (isAdmin) statusText = isOffline ? "üîì Admin (Offline - Not Syncing)" : "üîì Admin Mode (Editing)";
            
            statusOverlay.innerText = statusText;
            statusOverlay.style.color = isAdmin ? (isOffline ? "#fa0" : "#0f0") : "#aaa";
            
            loginBtn.innerText = isAdmin ? "üîì Logged In" : "üîë Admin Login";
            resetBtn.style.display = isAdmin ? "inline-block" : "none";

            tasks.forEach((taskName, i) => {
                const tileData = state[i] || { done: false };
                
                const tile = document.createElement('div');
                tile.className = 'tile';
                if (!isAdmin) tile.classList.add('readonly');
                tile.style.animationDelay = `${Math.random() * 2}s`;
                
                if (tileData.done) {
                    tile.classList.add('done');
                    completedCount++;
                }

                tile.innerHTML = `
                    <div class="check-mark">‚úì</div>
                    <div class="tile-name">${taskName}</div>
                `;

                // Click Logic
                tile.onclick = (e) => {
                    if (!isAdmin) {
                        // Viewer Mode
                        animateClick(tile);
                        playSound('click');
                        
                        confetti({
                            particleCount: 15, spread: 40,
                            origin: { x: e.clientX / window.innerWidth, y: e.clientY / window.innerHeight },
                            colors: ['#8c4b4f', '#b30000', '#5a2e2e'],
                            scalar: 0.8, shapes: ['circle']
                        });

                        const words = ["SQUISH", "POKE", "PLOP", "MOIST", "THWACK", "EW"];
                        const word = words[Math.floor(Math.random() * words.length)];
                        spawnFloater(e.clientX, e.clientY, word);
                        return;
                    }

                    // Admin Mode
                    tileData.done = !tileData.done;
                    animateClick(tile);
                    
                    if (tileData.done) {
                        playSound('complete');
                        spawnXpDrop(e.clientX, e.clientY, "+1 Bingo XP");
                        triggerConfetti(); 
                    } else {
                        playSound('click');
                        spawnFloater(e.clientX, e.clientY, "UNDO");
                    }

                    saveData();
                    render(); 
                    if (tileData.done && completedCount === 15) checkWin(); 
                };

                grid.appendChild(tile);
            });

            // Update Bars
            progressLabel.innerText = `${completedCount} / 16 COMPLETE`;
            const pct = (completedCount / 16) * 100;
            progressFill.style.width = `${pct}%`;

            if (completedCount === 16) {
                progressLabel.style.color = '#fff';
                progressLabel.innerHTML = "üí¶ BLACKOUT COMPLETE! üí¶";
            } else {
                progressLabel.style.color = '#d48a8a';
            }
        }

        function saveData() {
            if (isOffline) {
                localStorage.setItem('chode_offline_backup', JSON.stringify(state));
            } else if (boardRef) {
                updateDoc(boardRef, { tiles: state }).catch(e => {
                    console.error("Save failed", e);
                    handleDbError(e);
                });
            }
        }

        // --- EXPOSED FUNCTIONS ---
        
        window.enableOfflineMode = () => {
            isOffline = true;
            document.getElementById('db-error-overlay').style.display = 'none';
            // Try load backup
            const backup = localStorage.getItem('chode_offline_backup');
            if(backup) state = JSON.parse(backup);
            render();
            showToast("Offline Mode Active");
        };

        window.toggleAdmin = () => {
            playSound('click');
            if (isAdmin) {
                isAdmin = false;
                render();
            } else {
                const pass = prompt("Enter Admin Password:");
                if (pass === ADMIN_PASSWORD) {
                    isAdmin = true;
                    render();
                    showToast("Admin Mode Active");
                } else if (pass !== null) {
                    alert("Wrong password!");
                }
            }
        };
        
        window.toggleMute = () => {
            isMuted = !isMuted;
            document.getElementById('mute-btn').innerText = isMuted ? "üîá OFF" : "üîä ON";
        };

        window.localHype = () => {
             playSound('win');
             checkWin();
        };

        window.resetBoard = () => {
            if (!isAdmin) return;
            if(confirm("Clear the board for EVERYONE?")) {
                state = tasks.map(() => ({ done: false }));
                saveData();
                render();
            }
        };

        // --- EFFECTS ---
        function animateClick(element) {
            element.classList.remove('clicked');
            void element.offsetWidth; 
            element.classList.add('clicked');
        }
        
        function playSound(name) {
            if (isMuted || !sounds[name]) return;
            const s = sounds[name].cloneNode();
            s.volume = 0.4;
            s.play().catch(e => {});
        }

        function spawnFloater(x, y, text) {
            const el = document.createElement('div');
            el.className = 'floater';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }
        
        function spawnXpDrop(x, y, text) {
            const el = document.createElement('div');
            el.className = 'xp-drop';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1500);
        }

        function triggerConfetti() {
            confetti({
                particleCount: 40, spread: 70, origin: { y: 0.7 },
                colors: ['#ffcccc', '#ff9999', '#ffffff', '#b30000']
            });
        }

        function checkWin() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
            var randomInRange = (min, max) => Math.random() * (max - min) + min;
            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                var particleCount = 50 * (timeLeft / duration);
                var colors = ['#ffcccc', '#ff9999', '#ffffff', '#b30000'];
                confetti(Object.assign({}, defaults, { particleCount, colors: colors, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, colors: colors, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // 3D Tilt
        document.addEventListener('mousemove', (e) => {
            if (window.innerWidth < 768) return;
            const wrapper = document.getElementById('capture-wrapper');
            const x = e.clientX / window.innerWidth;
            const y = e.clientY / window.innerHeight;
            const rotateX = (0.5 - y) * TILT_STRENGTH;
            const rotateY = (x - 0.5) * TILT_STRENGTH;
            wrapper.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        });

        // Screenshot
        window.copyImage = async () => {
            document.getElementById('capture-wrapper').style.transform = 'none';
            const copyBtn = document.getElementById('copy-btn');
            const originalText = copyBtn.innerText;
            copyBtn.innerText = "Generating...";
            
            try {
                await new Promise(r => setTimeout(r, 50));
                const element = document.getElementById('capture-area');
                const canvas = await html2canvas(element, {
                    backgroundColor: null, scale: 2, 
                    ignoreElements: (el) => el.hasAttribute('data-html2canvas-ignore') || el.id === 'status-overlay'
                });

                canvas.toBlob(async blob => {
                    try {
                        const item = new ClipboardItem({ "image/png": blob });
                        await navigator.clipboard.write([item]);
                        window.showToast("Image Copied!");
                    } catch (err) {
                        window.showModal(canvas.toDataURL());
                    }
                    copyBtn.innerText = originalText;
                });
            } catch (err) {
                console.error(err);
                alert("Error generating image.");
                copyBtn.innerText = originalText;
            }
        };

        window.showModal = (dataUrl) => {
            document.getElementById('modal-img').src = dataUrl;
            document.getElementById('modal-overlay').style.display = 'flex';
        };
        window.closeModal = () => document.getElementById('modal-overlay').style.display = 'none';
        
        window.showToast = (text) => {
            const t = document.getElementById('toast');
            if(text) t.innerText = text;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        };

        init();

    </script>
</body>
</html>
